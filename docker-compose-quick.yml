# ANDE Chain Quick Start - Using Reth directly
version: '3.9'

networks:
  andechain:
    name: andechain
    driver: bridge

volumes:
  reth-data:
    driver: local
  jwttoken:
    driver: local

services:
  # JWT Token Initialization
  jwt-init:
    container_name: jwt-init
    image: alpine:3.22.0
    volumes:
      - jwttoken:/jwt
    command:
      - "/bin/sh"
      - "-c"
      - "if [ ! -f /jwt/jwt.hex ]; then apk add --no-cache openssl && openssl rand -hex 32 | tr -d '\\n' > /jwt/jwt.hex && echo 'JWT generated'; else echo 'JWT exists'; fi"
    networks:
      - andechain

  # ANDE Node using Reth directly
  ande-node:
    container_name: ande-node
    image: ghcr.io/paradigmxyz/reth:v1.1.3
    restart: unless-stopped
    depends_on:
      jwt-init:
        condition: service_completed_successfully
    ports:
      - "8545:8545"   # HTTP RPC
      - "8546:8546"   # WebSocket
      - "8551:8551"   # Engine API
      - "9001:9001"   # Metrics
      - "30303:30303" # P2P TCP
      - "30303:30303/udp" # P2P UDP
    volumes:
      - ./specs/genesis.json:/genesis.json:ro
      - jwttoken:/jwt:ro
      - reth-data:/data
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    command:
      - node
      - --datadir=/data
      - --chain=/genesis.json
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.api=admin,eth,net,web3,txpool,debug,trace
      - --http.corsdomain=*
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.api=eth,net,web3,txpool
      - --ws.origins=*
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.jwtsecret=/jwt/jwt.hex
      - --port=30303
      - --max-outbound-peers=25
      - --max-inbound-peers=25
      - --disable-discovery
      - --metrics=0.0.0.0:9001
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q -O- --post-data='{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"params\":[],\"id\":1}' --header='Content-Type:application/json' http://localhost:8545 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - andechain