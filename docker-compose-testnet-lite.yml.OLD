# ANDE Chain Testnet - Multi-Sequencer Lite
# Simplified version without explorer for initial deployment

version: '3.8'

services:
  # JWT Token Generator
  jwt-init:
    image: alpine:3.22.0
    command: >
      sh -c "
        if [ ! -f /data/jwt.hex ]; then
          apk add --no-cache openssl &&
          openssl rand -hex 32 > /data/jwt.hex &&
          echo 'JWT token generated successfully';
        else
          echo 'JWT token already exists';
        fi
      "
    volumes:
      - jwttoken:/data
    networks:
      - andechain-testnet

  # Sequencer Node 1 (Primary)
  ande-sequencer-1:
    image: ghcr.io/paradigmxyz/reth:v1.1.3
    container_name: ande-sequencer-1
    hostname: sequencer-1
    restart: unless-stopped
    depends_on:
      - jwt-init
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
      - "9090:9090"
    networks:
      - andechain-testnet
    env_file:
      - .env.testnet
    volumes:
      - sequencer-1-data:/data/ande-chain
      - jwttoken:/data/jwt:ro
    command: >
      node
      --chain /data/ande-chain/genesis.json
      --datadir /data/ande-chain
      --http
      --http.addr 0.0.0.0
      --http.port 8545
      --http.api eth,net,web3
      --ws
      --ws.addr 0.0.0.0
      --ws.port 8546
      --authrpc.jwtsecret /data/jwt/jwt.hex
      --authrpc.addr 0.0.0.0
      --authrpc.port 8551

  # Prometheus Monitoring
  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: ande-prometheus
    restart: unless-stopped
    ports:
      - "9093:9090"
    networks:
      - andechain-testnet
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'

  # Grafana Dashboard
  grafana:
    image: grafana/grafana:11.3.0
    container_name: ande-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    networks:
      - andechain-testnet
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=ande2024
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus

  # Celestia Light Node
  celestia-light:
    image: ghcr.io/celestiaorg/celestia-node:v0.20.2
    container_name: celestia-light
    restart: unless-stopped
    ports:
      - "26658:26658"
      - "26659:26659"
    networks:
      - andechain-testnet
    command: >
      celestia light start
      --core.ip rpc.celestia-mocha.com
      --gateway
      --gateway.addr 0.0.0.0
      --gateway.port 26659
      --p2p.network mocha-4
    volumes:
      - celestia-data:/home/celestia/.celestia-light

networks:
  andechain-testnet:
    driver: bridge

volumes:
  jwttoken:
  sequencer-1-data:
  prometheus-data:
  grafana-data:
  celestia-data:
