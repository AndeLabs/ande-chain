# ANDE Chain Testnet Deployment
# Premium Multi-Sequencer Configuration for Celestia Mocha-4

version: '3.8'

x-sequencer-common: &sequencer-common
  build:
    context: .
    dockerfile: Dockerfile
    args:
      - CHAIN_ID=6174
      - NETWORK=testnet
  restart: unless-stopped
  networks:
    - andechain-testnet
  env_file:
    - .env.testnet
  volumes:
    - jwttoken:/data/jwt
  logging:
    driver: "json-file"
    options:
      max-size: "100m"
      max-file: "10"

services:
  # =========================================================================
  # JWT Token Generator
  # =========================================================================
  jwt-init:
    image: alpine:3.22.0
    command: >
      sh -c "
        if [ ! -f /data/jwt.hex ]; then
          apk add --no-cache openssl &&
          openssl rand -hex 32 > /data/jwt.hex &&
          echo 'JWT token generated successfully';
        else
          echo 'JWT token already exists';
        fi
      "
    volumes:
      - jwttoken:/data
    networks:
      - andechain-testnet

  # =========================================================================
  # Sequencer Node 1 (Primary)
  # =========================================================================
  ande-sequencer-1:
    <<: *sequencer-common
    container_name: ande-sequencer-1
    hostname: sequencer-1
    depends_on:
      - jwt-init
    ports:
      - "8545:8545"   # HTTP RPC
      - "8546:8546"   # WebSocket RPC
      - "30303:30303" # P2P
      - "9090:9090"   # Metrics
    environment:
      - SEQUENCER_ID=1
      - SEQUENCER_ADDRESS=${SEQUENCER_1_ADDRESS}
      - SEQUENCER_PRIVATE_KEY=${SEQUENCER_1_PRIVATE_KEY}
      - P2P_PORT=30303
      - RPC_PORT=8545
      - WS_PORT=8546
      - METRICS_PORT=9090
      - LOG_LEVEL=info
    volumes:
      - sequencer-1-data:/data/ande-chain
      - sequencer-1-logs:/logs
      - jwttoken:/data/jwt:ro
      - ./specs/genesis.json:/genesis.json:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =========================================================================
  # Sequencer Node 2 (Backup)
  # =========================================================================
  ande-sequencer-2:
    <<: *sequencer-common
    container_name: ande-sequencer-2
    hostname: sequencer-2
    depends_on:
      - jwt-init
      - ande-sequencer-1
    ports:
      - "8547:8545"   # HTTP RPC (different port)
      - "8548:8546"   # WebSocket RPC
      - "30304:30303" # P2P
      - "9091:9090"   # Metrics
    environment:
      - SEQUENCER_ID=2
      - SEQUENCER_ADDRESS=${SEQUENCER_2_ADDRESS}
      - SEQUENCER_PRIVATE_KEY=${SEQUENCER_2_PRIVATE_KEY}
      - P2P_PORT=30303
      - RPC_PORT=8545
      - WS_PORT=8546
      - METRICS_PORT=9090
      - P2P_BOOTNODES=enode://sequencer-1:30303
      - LOG_LEVEL=info
    volumes:
      - sequencer-2-data:/data/ande-chain
      - sequencer-2-logs:/logs
      - jwttoken:/data/jwt:ro
      - ./specs/genesis.json:/genesis.json:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =========================================================================
  # Sequencer Node 3 (Backup)
  # =========================================================================
  ande-sequencer-3:
    <<: *sequencer-common
    container_name: ande-sequencer-3
    hostname: sequencer-3
    depends_on:
      - jwt-init
      - ande-sequencer-1
    ports:
      - "8549:8545"   # HTTP RPC
      - "8550:8546"   # WebSocket RPC
      - "30305:30303" # P2P
      - "9092:9090"   # Metrics
    environment:
      - SEQUENCER_ID=3
      - SEQUENCER_ADDRESS=${SEQUENCER_3_ADDRESS}
      - SEQUENCER_PRIVATE_KEY=${SEQUENCER_3_PRIVATE_KEY}
      - P2P_PORT=30303
      - RPC_PORT=8545
      - WS_PORT=8546
      - METRICS_PORT=9090
      - P2P_BOOTNODES=enode://sequencer-1:30303
      - LOG_LEVEL=info
    volumes:
      - sequencer-3-data:/data/ande-chain
      - sequencer-3-logs:/logs
      - jwttoken:/data/jwt:ro
      - ./specs/genesis.json:/genesis.json:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =========================================================================
  # Prometheus Monitoring
  # =========================================================================
  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: ande-prometheus
    hostname: prometheus
    restart: unless-stopped
    ports:
      - "9093:9090"
    networks:
      - andechain-testnet
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================================
  # Grafana Dashboard
  # =========================================================================
  grafana:
    image: grafana/grafana:11.3.0
    container_name: ande-grafana
    hostname: grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    networks:
      - andechain-testnet
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-ande2024}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
      - GF_SERVER_ROOT_URL=http://localhost:3001
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================================
  # ANDE Explorer
  # =========================================================================
  explorer:
    build:
      context: ../ande-explorer/frontend
      dockerfile: Dockerfile
    container_name: ande-explorer
    hostname: explorer
    restart: unless-stopped
    ports:
      - "3000:3000"
    networks:
      - andechain-testnet
    environment:
      - NEXT_PUBLIC_RPC_URL=http://ande-sequencer-1:8545
      - NEXT_PUBLIC_WS_URL=ws://ande-sequencer-1:8546
      - NEXT_PUBLIC_CHAIN_ID=6174
      - NEXT_PUBLIC_NETWORK_NAME=ANDE Testnet
      - NEXT_PUBLIC_EXPLORER_NAME=ANDE Explorer
    depends_on:
      - ande-sequencer-1
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================================
  # Celestia Light Node (Data Availability)
  # =========================================================================
  celestia-light:
    image: ghcr.io/celestiaorg/celestia-node:v0.20.2
    container_name: celestia-light
    hostname: celestia-light
    restart: unless-stopped
    ports:
      - "26658:26658"  # RPC
      - "26659:26659"  # Gateway
    networks:
      - andechain-testnet
    command: >
      celestia light start
      --core.ip rpc.celestia-mocha.com
      --gateway
      --gateway.addr 0.0.0.0
      --gateway.port 26659
      --p2p.network mocha-4
    volumes:
      - celestia-data:/home/celestia/.celestia-light
    environment:
      - CELESTIA_CUSTOM=mocha-4
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:26658/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # =========================================================================
  # HAProxy Load Balancer
  # =========================================================================
  haproxy:
    image: haproxy:3.0.6-alpine
    container_name: ande-haproxy
    hostname: haproxy
    restart: unless-stopped
    ports:
      - "80:80"     # HTTP
      - "443:443"   # HTTPS
      - "8404:8404" # Stats
    networks:
      - andechain-testnet
    volumes:
      - ./monitoring/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - ande-sequencer-1
      - ande-sequencer-2
      - ande-sequencer-3
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  andechain-testnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  jwttoken:
    driver: local
  sequencer-1-data:
    driver: local
  sequencer-1-logs:
    driver: local
  sequencer-2-data:
    driver: local
  sequencer-2-logs:
    driver: local
  sequencer-3-data:
    driver: local
  sequencer-3-logs:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  celestia-data:
    driver: local
