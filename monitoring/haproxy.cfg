# HAProxy Configuration for ANDE Chain Testnet
# Premium Multi-Sequencer Load Balancing

global
    log stdout format raw local0
    maxconn 4096
    daemon

    # Performance tuning
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# ============================================================================
# FRONTEND - HTTP RPC Load Balancer
# ============================================================================
frontend http_rpc
    bind *:80
    mode http

    # CORS headers for blockchain RPC
    http-response add-header Access-Control-Allow-Origin "*"
    http-response add-header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    http-response add-header Access-Control-Allow-Headers "Content-Type, Authorization"

    # Handle preflight OPTIONS requests
    acl is_options method OPTIONS
    http-request return status 200 if is_options

    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # Route to RPC backend
    default_backend rpc_sequencers

# ============================================================================
# BACKEND - Multi-Sequencer RPC Pool
# ============================================================================
backend rpc_sequencers
    mode http
    balance roundrobin

    # Health checks
    option httpchk POST /
    http-check send meth POST uri / ver HTTP/1.1 hdr Content-Type application/json body '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
    http-check expect status 200

    # Server timeout for long-running RPC calls
    timeout server 60s

    # Sequencer nodes with health checks
    server sequencer-1 ande-sequencer-1:8545 check inter 10s fall 3 rise 2 weight 100
    server sequencer-2 ande-sequencer-2:8545 check inter 10s fall 3 rise 2 weight 50 backup
    server sequencer-3 ande-sequencer-3:8545 check inter 10s fall 3 rise 2 weight 50 backup

# ============================================================================
# FRONTEND - WebSocket Load Balancer
# ============================================================================
frontend ws_frontend
    bind *:8546
    mode http

    # Upgrade to WebSocket
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_websocket hdr_beg(Host) -i ws

    use_backend ws_sequencers if is_websocket
    default_backend ws_sequencers

# ============================================================================
# BACKEND - WebSocket Pool
# ============================================================================
backend ws_sequencers
    mode http
    balance roundrobin

    # WebSocket specific settings
    option http-server-close
    option forceclose
    timeout tunnel 3600s
    timeout server 3600s

    # Health checks for WebSocket
    option httpchk GET /health

    server sequencer-1-ws ande-sequencer-1:8546 check inter 10s fall 3 rise 2
    server sequencer-2-ws ande-sequencer-2:8546 check inter 10s fall 3 rise 2 backup
    server sequencer-3-ws ande-sequencer-3:8546 check inter 10s fall 3 rise 2 backup

# ============================================================================
# FRONTEND - Stats Dashboard
# ============================================================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node
    stats admin if TRUE

    # Prometheus metrics endpoint
    http-request use-service prometheus-exporter if { path /metrics }

# ============================================================================
# FRONTEND - HTTPS (for production - requires SSL certificates)
# ============================================================================
# frontend https_rpc
#     bind *:443 ssl crt /etc/ssl/certs/ande-chain.pem
#     mode http
#
#     # Security headers
#     http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#     http-response set-header X-Frame-Options "DENY"
#     http-response set-header X-Content-Type-Options "nosniff"
#     http-response set-header X-XSS-Protection "1; mode=block"
#
#     default_backend rpc_sequencers

# ============================================================================
# MONITORING
# ============================================================================
listen prometheus_metrics
    bind *:9101
    mode http
    http-request use-service prometheus-exporter
    no log
